<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>AIプロンプトメーカー（Grok連携） - キャッシュ回避版</title>
    <style>
        body { font-family: sans-serif; padding: 20px; max-width: 450px; margin: auto; }
        input, textarea, select { width: 100%; padding: 8px; margin: 5px 0; box-sizing: border-box; }
        button { background: #007bff; color: white; padding: 10px; border: none; width: 100%; cursor: pointer; margin: 5px 0; }
        button:hover { background: #0056b3; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        #output { border: 1px solid #ccc; min-height: 100px; }
        .grok-link { background: #28a745; }
        .section { margin: 10px 0; border: 1px solid #ddd; padding: 10px; border-radius: 5px; }
        label { font-size: 12px; color: #666; display: block; margin-top: 5px; }
        .checkbox { width: auto; margin: 5px 0; }
        .warning { color: orange; font-size: 11px; }
        .loading { color: blue; font-size: 11px; }
        .success { color: green; font-size: 11px; }
        .progress { background: #f0f0f0; padding: 10px; border-radius: 5px; margin: 5px 0; font-family: monospace; font-size: 10px; max-height: 200px; overflow-y: auto; border: 1px solid #ddd; }
        .progress-item { margin: 2px 0; padding: 2px; }
        .progress-item.complete { color: green; }
        .progress-item.error { color: red; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@xenova/transformers@2.15.1"></script>
</head>
<body>
    <h1>AIプロンプトメーカー（Grok連携） - キャッシュ回避版</h1>
    <p>日本語入力OK！ メタタグでキャッシュ無効化。初回ダウンロード進捗リスト表示（iOSコンソール確認推奨）</p>
    
    <div class="section">
        <h3>基本（必須）</h3>
        <label>主題: </label>
        <input type="text" id="subject" placeholder="例: うさぎ少女（今すぐテスト）" />
        <label>スタイル: </label>
        <select id="style">
            <option value="">ランダム</option>
            <option value="realistic">realistic (リアル)</option>
            <option value="anime">anime (アニメ)</option>
            <option value="cartoon">cartoon (カートゥーン)</option>
            <option value="fantasy">fantasy (ファンタジー)</option>
            <option value="cyberpunk">cyberpunk (サイバーパンク)</option>
            <option value="steampunk">steampunk (スチームパンク)</option>
        </select>
        <label>ムード: </label>
        <select id="mood">
            <option value="">ランダム</option>
            <option value="warm">warm (温かみ)</option>
            <option value="cool">cool (クール)</option>
            <option value="mysterious">mysterious (神秘的)</option>
            <option value="joyful">joyful (喜び)</option>
            <option value="melancholic">melancholic (憂鬱)</option>
        </select>
    </div>
    
    <!-- 他のセクション（キャラ詳細、背景/品質、動画オプション）は前のコードと同じ。省略せずコピーしてね -->
    <div class="section">
        <h3>キャラ詳細（オプション）</h3>
        <label>年齢: </label>
        <select id="age">
            <option value="">指定なし</option>
            <option value="young">young (若い)</option>
            <option value="adult">adult (大人)</option>
            <option value="elderly">elderly (老人)</option>
            <option value="teen">teen (ティーン)</option>
        </select>
        <label>肌の色: </label>
        <select id="skin">
            <option value="">指定なし</option>
            <option value="fair">fair (色白)</option>
            <option value="tan">tan (小麦)</option>
            <option value="dark">dark (暗め)</option>
            <option value="olive">olive (オリーブ)</option>
        </select>
        <label>髪色: </label>
        <select id="hair">
            <option value="">指定なし</option>
            <option value="blue">blue (青)</option>
            <option value="red">red (赤)</option>
            <option value="black">black (黒)</option>
            <option value="blonde">blonde (金)</option>
            <option value="pink">pink (ピンク)</option>
            <option value="silver">silver (銀)</option>
            <option value="green">green (緑)</option>
        </select>
        <label>髪型: </label>
        <select id="hairstyle">
            <option value="">指定なし</option>
            <option value="long straight">long straight (ロングストレート)</option>
            <option value="curly">curly (カーリー)</option>
            <option value="short bob">short bob (ショートボブ)</option>
            <option value="ponytail">ponytail (ポニーテール)</option>
            <option value="braids">braids (三つ編み)</option>
            <option value="wavy">wavy (ウェーブ)</option>
            <option value="messy">messy (無造作)</option>
            <option value="updo">updo (アップ)</option>
        </select>
        <label>目の色: </label>
        <select id="eyes">
            <option value="">指定なし</option>
            <option value="green">green (緑)</option>
            <option value="blue">blue (青)</option>
            <option value="red">red (赤)</option>
            <option value="brown">brown (茶)</option>
            <option value="golden">golden (金)</option>
        </select>
        <label>服装: </label>
        <select id="clothing">
            <option value="">指定なし</option>
            <option value="flowing dress">flowing dress (ドレス)</option>
            <option value="sharp suit">sharp suit (スーツ)</option>
            <option value="intricate armor">intricate armor (鎧)</option>
            <option value="casual jeans">casual jeans (カジュアル)</option>
            <option value="gothic lolita">gothic lolita (ゴスロリ)</option>
            <option value="school uniform">school uniform (制服)</option>
        </select>
        <label>ポーズ: </label>
        <select id="pose">
            <option value="">指定なし</option>
            <option value="standing">standing (立っている)</option>
            <option value="sitting">sitting (座っている)</option>
            <option value="dynamic">dynamic (ダイナミック)</option>
            <option value="relaxed">relaxed (リラックス)</option>
            <option value="action pose">action pose (アクションポーズ)</option>
        </select>
    </div>
    
    <div class="section">
        <h3>背景/品質（オプション）</h3>
        <label>季節の行事: </label>
        <select id="seasonal">
            <option value="">指定なし</option>
            <option value="christmas">Christmas (クリスマス)</option>
            <option value="halloween">Halloween (ハロウィン)</option>
            <option value="newyear">New Year (お正月)</option>
            <option value="cherryblossom">Cherry Blossom (桜)</option>
            <option value="summerfestival">Summer Festival (夏祭り)</option>
            <option value="autumnleaves">Autumn Leaves (紅葉)</option>
            <option value="valentines">Valentine's Day (バレンタイン)</option>
            <option value="halloween night">Halloween Night (ハロウィンナイト)</option>
        </select>
        <label>背景: </label>
        <select id="background">
            <option value="">指定なし</option>
            <option value="enchanted forest">enchanted forest (森)</option>
            <option value="serene ocean">serene ocean (海)</option>
            <option value="bustling city">bustling city (街)</option>
            <option value="futuristic cityscape">futuristic cityscape (未来都市)</option>
            <option value="fantasy realm">fantasy realm (ファンタジー世界)</option>
            <option value="snowy mountain">snowy mountain (雪山)</option>
            <option value="sunset beach">sunset beach (夕焼けビーチ)</option>
        </select>
        <label>照明: </label>
        <select id="lighting">
            <option value="">指定なし</option>
            <option value="soft">soft (柔らか)</option>
            <option value="dramatic">dramatic (劇的)</option>
            <option value="natural">natural (自然)</option>
            <option value="golden hour">golden hour (ゴールデンアワー)</option>
        </select>
        <label>詳細度: </label>
        <select id="detail">
            <option value="">標準</option>
            <option value="high">high (高詳細)</option>
            <option value="low">low (低詳細)</option>
            <option value="ultra">ultra (超詳細)</option>
        </select>
        <label>解像度: </label>
        <select id="resolution">
            <option value="">標準</option>
            <option value="4k">4K (高解像)</option>
            <option value="hd">HD (標準)</option>
            <option value="8k">8K (超高解像)</option>
        </select>
    </div>
    
    <div class="section">
        <h3>動画オプション（動画モード時）</h3>
        <label>モード: </label>
        <select id="mode">
            <option value="image">画像</option>
            <option value="video">動画</option>
        </select>
        <label>カメラワーク: </label>
        <select id="camera">
            <option value="">ランダム</option>
            <option value="close-up">close-up (クローズアップ)</option>
            <option value="wide shot">wide shot (ワイドショット)</option>
            <option value="tracking shot">tracking shot (トラッキングショット)</option>
            <option value="aerial view">aerial view (空中ショット)</option>
            <option value="slow pan">slow pan (スローパン)</option>
            <option value="quick cut">quick cut (クイックカット)</option>
            <option value="dolly zoom">dolly zoom (ドリーズーム)</option>
        </select>
        <label>動作: </label>
        <select id="action">
            <option value="">ランダム</option>
            <option value="standing">standing (立っている)</option>
            <option value="walking">walking (歩いている)</option>
            <option value="jumping">jumping (ジャンプ)</option>
            <option value="smiling">smiling (微笑む)</option>
            <option value="dancing">dancing (ダンス)</option>
            <option value="fighting">fighting (戦う)</option>
            <option value="running">running (走る)</option>
        </select>
    </div>
    
    <label class="checkbox">
        <input type="checkbox" id="openGrok" checked> Grokページを開く（OFFで出力&コピーだけ）
    </label>
    <label class="checkbox">
        <input type="checkbox" id="useTransformers"> オフライン翻訳使用（iOSではオフ推奨）
    </label>
    <div id="warning" class="warning" style="display:none;"></div>
    <div id="progress" class="progress" style="display:none;"></div>
    <div id="loading" class="loading" style="display:none;">翻訳モデルをロード中...（初回のみ）</div>
    <div id="status" class="success" style="display:none;"></div>
    
    <button id="generateBtn">Grokに送る（生成+開く）</button>
    <textarea id="output" placeholder="ここに最適プロンプトが出力..."></textarea>
    <button class="grok-link" id="openGrokBtn">Grokページだけ開く</button>

    <script>
        // 辞書（上書き関連追加: 冗談で）
        const translations = {
            '上書き': 'overwrite', '反映': 'reflect', '再起動': 'restart',
            '猫娘': 'detailed cat girl with ears and tail', '猫': 'cat', '女': 'girl', '娘': 'girl',
            'うさぎ少女': 'cute bunny girl with ears and tail', 'うさぎ': 'bunny', '少女': 'girl',
            'キツネ娘': 'fox girl with ears and tail', 'キツネ': 'fox',
            '犬': 'dog', 'うさぎ': 'rabbit', 'エルフ': 'elf with pointed ears', 'ヴァンパイア': 'vampire with fangs',
            'ドラゴン': 'dragon', '魔法使い': 'wizard', '戦士': 'warrior', 'ロボット': 'robot',
            'かわいい': 'cute and whimsical', '怖い': 'scary and eerie', '美しい': 'beautiful and elegant', 
            '楽しい': 'fun and lively', '静かな': 'peaceful and serene', '激しい': 'intense and dynamic',
            '優雅': 'graceful', '力強い': 'powerful', '神秘的': 'mystical',
            '青い髪': 'blue hair', '赤い髪': 'red hair', '黒髪': 'black hair', '金髪': 'blonde hair',
            'ピンク髪': 'pink hair', '銀髪': 'silver hair', '緑髪': 'green hair', '紫髪': 'purple hair',
            '緑の目': 'green eyes', '青い目': 'blue eyes', '赤い目': 'red eyes', '目': 'eyes',
            '茶色の目': 'brown eyes', '金色の目': 'golden eyes', '紫の目': 'purple eyes',
            'ドレス': 'flowing dress', 'スーツ': 'sharp suit', '鎧': 'intricate armor',
            'ジーンズ': 'casual jeans', 'ゴスロリ': 'gothic lolita', '制服': 'school uniform',
            '浴衣': 'yukata', '着物': 'kimono',
            '森': 'enchanted forest', '海': 'serene ocean', '街': 'bustling city', '未来': 'futuristic cityscape',
            'ファンタジー': 'fantasy realm', '冒険': 'adventurous landscape', '雪山': 'snowy mountain',
            'ビーチ': 'sunset beach', '城': 'ancient castle', '宇宙': 'cosmic space',
            'クリスマス': 'Christmas', 'ハロウィン': 'Halloween', 'お正月': 'New Year', '桜': 'Cherry Blossom',
            '夏祭り': 'Summer Festival', '紅葉': 'Autumn Leaves', 'バレンタイン': "Valentine's Day",
            'ハロウィンナイト': 'Halloween Night',
            'ロングストレート': 'long straight', 'カーリー': 'curly', 'ショートボブ': 'short bob', 
            'ポニーテール': 'ponytail', '三つ編み': 'braids', 'ウェーブ': 'wavy', '無造作': 'messy',
            'アップ': 'updo'
        };

        let translator = null;
        let loadStartTime = null;

        // 進捗コールバック（iOSログ強化）
        function progressCallback(data) {
            const progressDiv = document.getElementById('progress');
            progressDiv.style.display = 'block';
            let step = data.status || data.task || 'Unknown step';
            const elapsed = loadStartTime ? Math.round((Date.now() - loadStartTime) / 1000) : 0;
            let percent = 0;
            const steps = ['Downloading tokenizer', 'Downloading model', 'Loading tokenizer', 'Loading model', 'Ready'];
            const stepIndex = steps.indexOf(step);
            if (stepIndex >= 0) percent = Math.round((stepIndex + 1) / steps.length * 100);
            const log = document.createElement('div');
            log.className = `progress-item ${step === 'Ready' ? 'complete' : ''}`;
            log.textContent = `[${percent}%] ${step} (${elapsed}s経過)`;
            progressDiv.appendChild(log);
            progressDiv.scrollTop = progressDiv.scrollHeight;
            // iOSコンソール出力強化
            console.log(`[進捗] ${step} (${percent}%) - 時間: ${elapsed}s`);
        }

        // Transformers.js翻訳関数
        async function translateWithTransformers(text) {
            const useTf = document.getElementById('useTransformers').checked;
            if (!useTf || !text || text.trim().length < 1) return null;
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
            if (isIOS) {
                console.log('[iOSモード] 進捗をコンソール出力（Safari開発メニューで確認）');
            }
            try {
                if (!translator) {
                    document.getElementById('loading').style.display = 'block';
                    document.getElementById('progress').innerHTML = '';
                    loadStartTime = Date.now();
                    console.log('[開始] モデルダウンロード開始');
                    const timeout = setTimeout(() => {
                        throw new Error('ロードタイムアウト（5分超）。辞書に切り替え');
                    }, 300000);
                    translator = await pipeline('translation', 'Xenova/nllb-200-distilled-600M', { 
                        quantized: false,
                        progress_callback: progressCallback
                    });
                    clearTimeout(timeout);
                    document.getElementById('loading').style.display = 'none';
                    const completeLog = document.createElement('div');
                    completeLog.className = 'progress-item complete';
                    completeLog.textContent = '[100%] モデルダウンロード完了！ 次回オフライン使用可能';
                    document.getElementById('progress').appendChild(completeLog);
                    console.log('[完了] ダウンロード成功 - オフラインOK');
                    document.getElementById('status').textContent = 'ダウンロード成功！ オフライン翻訳OK';
                    document.getElementById('status').style.display = 'block';
                }
                console.log(`[翻訳開始] テキスト: ${text}`);
                const output = await translator(text, { src_lang: 'jpn_Jpan' });
                let translated = output[0].translation_text;
                if (translated.trim().length < 2) throw new Error('翻訳出力が短すぎます');
                console.log(`[翻訳完了] 出力: ${translated}`);
                return translated;
            } catch (e) {
                console.error('[エラー] Transformers.js詳細:', e);
                const errorLog = document.createElement('div');
                errorLog.className = 'progress-item error';
                errorLog.textContent = `[エラー] ${e.message}`;
                document.getElementById('progress').appendChild(errorLog);
                document.getElementById('warning').textContent = `翻訳エラー: ${e.message}（辞書に切り替えました）`;
                document.getElementById('warning').style.display = 'block';
                return null;
            }
        }

        // 辞書翻訳（変更なし）
        function translateWithDict(input) {
            if (!input) return input;
            let untranslated = input;
            const words = input.split(/\s+/);
            let translated = words.map(word => {
                for (let key in translations) {
                    if (word.includes(key)) {
                        word = word.replace(key, translations[key]);
                        untranslated = untranslated.replace(key, '');
                        break;
                    }
                }
                return word;
            }).join(' ');
            const remainingJa = untranslated.match(/[\u3040-\u309F\u3400-\u4DBF\u4E00-\u9FFF]/g);
            if (remainingJa) {
                console.warn('[辞書] 未翻訳: ', remainingJa.join(''));
                document.getElementById('warning').textContent = `一部翻訳漏れ: ${remainingJa.join('')}（辞書追加可能）`;
                document.getElementById('warning').style.display = 'block';
            }
            return translated.replace(/\s+/g, ' ').trim();
        }

        // generatePrompt, generateAndOpenGrok, copyToClipboard, openGrokDirectly（前のと同じ、変更なし）
        async function generatePrompt(subject, style, mood, age, skin, hair, hairstyle, eyes, clothing, pose, seasonal, background, lighting, detail, resolution, mode, camera, action) {
            try {
                let translatedSubject = await translateWithTransformers(subject);
                if (!translatedSubject) {
                    translatedSubject = translateWithDict(subject);
                }
                if (!translatedSubject) {
                    throw new Error('翻訳が空です。主題を再確認！');
                }

                let basePrompt = "Create a {style} image of a highly detailed " + translatedSubject + " as the main focus of the scene";
                if (mood) basePrompt += " in a {mood} mood";
                basePrompt += ". ";

                let charDetails = [];
                if (age) charDetails.push(age);
                if (skin) charDetails.push(`${skin} skin`);
                if (hair) charDetails.push(`${hair} hair`);
                if (hairstyle) charDetails.push(`${hairstyle} hairstyle`);
                if (eyes) charDetails.push(`${eyes} eyes`);
                if (clothing) charDetails.push(`wearing ${clothing}`);
                if (pose) charDetails.push(`in a ${pose} pose`);
                if (charDetails.length > 0) {
                    basePrompt += ' featuring ' + charDetails.join(', ') + '. ';
                }

                let addDetails = [];
                if (seasonal) addDetails.push(`in a ${seasonal} setting`);
                if (background) addDetails.push(`in a ${background} background`);
                if (lighting) addDetails.push(`with ${lighting} lighting`);
                if (detail && detail !== '') addDetails.push(detail === 'high' ? 'high detail' : detail === 'low' ? 'low detail' : 'ultra detail');
                if (resolution && resolution !== '') addDetails.push(`${resolution} resolution`);
                if (addDetails.length > 0) {
                    basePrompt += ' ' + addDetails.join(', ') + '. ';
                }

                basePrompt += "Use vibrant colors, sharp focus, and professional composition.";

                const styles = ['realistic', 'anime', 'cartoon', 'fantasy', 'cyberpunk', 'steampunk'];
                const moods = ['warm', 'cool', 'mysterious', 'joyful', 'melancholic'];
                let finalStyle = style || styles[Math.floor(Math.random() * styles.length)];
                let finalMood = mood || moods[Math.floor(Math.random() * moods.length)];

                let prompt = basePrompt
                    .replace('{style}', finalStyle)
                    .replace('{mood}', finalMood);

                if (mode === 'video') {
                    let videoDetails = [];
                    if (camera) videoDetails.push(`${camera} camera work`);
                    if (action) videoDetails.push(`${action} action`);
                    prompt = "Create a short animated video scene using cinematic techniques, where 'camera work' refers to film shots, not literal cameras held by characters. The character does not hold or use a camera. " + prompt;
                    if (videoDetails.length > 0) {
                        prompt += " with " + videoDetails.join(' and ') + ". Smooth animation, high quality 4K.";
                    } else {
                        prompt += ". Smooth animation, high quality 4K.";
                    }
                }

                prompt = prompt.replace(/[\u3040-\u309F\u3400-\u4DBF\u4E00-\u9FFF]/g, '').replace(/\s+/g, ' ').trim();
                return prompt;
            } catch (e) {
                console.error('生成エラー:', e);
                document.getElementById('warning').textContent = e.message;
                document.getElementById('warning').style.display = 'block';
                return 'エラーが発生しました。キーワードをシンプルに試してね！';
            }
        }

        async function generateAndOpenGrok() {
            const subject = document.getElementById('subject').value.trim();
            const generateBtn = document.getElementById('generateBtn');
            generateBtn.disabled = true;
            generateBtn.textContent = '生成中...';
            const style = document.getElementById('style').value;
            const mood = document.getElementById('mood').value;
            const age = document.getElementById('age').value;
            const skin = document.getElementById('skin').value;
            const hair = document.getElementById('hair').value;
            const hairstyle = document.getElementById('hairstyle').value;
            const eyes = document.getElementById('eyes').value;
            const clothing = document.getElementById('clothing').value;
            const pose = document.getElementById('pose').value;
            const seasonal = document.getElementById('seasonal').value;
            const background = document.getElementById('background').value;
            const lighting = document.getElementById('lighting').value;
            const detail = document.getElementById('detail').value;
            const resolution = document.getElementById('resolution').value;
            const mode = document.getElementById('mode').value;
            const camera = document.getElementById('camera').value;
            const action = document.getElementById('action').value;
            const openGrok = document.getElementById('openGrok').checked;

            document.getElementById('warning').style.display = 'none';
            document.getElementById('status').style.display = 'none';

            if (!subject) {
                alert('主題を入れて！');
                generateBtn.disabled = false;
                generateBtn.textContent = 'Grokに送る（生成+開く）';
                return;
            }

            const prompt = await generatePrompt(subject, style, mood, age, skin, hair, hairstyle, eyes, clothing, pose, seasonal, background, lighting, detail, resolution, mode, camera, action);
            document.getElementById('output').value = prompt;
            copyToClipboard(prompt);
            if (openGrok) {
                openGrokDirectly();
            }
            generateBtn.disabled = false;
            generateBtn.textContent = 'Grokに送る（生成+開く）';
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                alert('プロンプトをコピーしました！ Grokに貼り付けてね。');
            }).catch(() => {
                const textarea = document.createElement('textarea');
                textarea.value = text;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                alert('コピーOK！');
            });
        }

        function openGrokDirectly() {
            window.open('https://x.com/grok', '_blank');
        }

        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('generateBtn').addEventListener('click', generateAndOpenGrok);
            document.getElementById('openGrokBtn').addEventListener('click', openGrokDirectly);
        });
    </script>
</body>
</html>
